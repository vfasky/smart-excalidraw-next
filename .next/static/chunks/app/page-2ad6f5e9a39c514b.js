(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8974],{305:(e,t,s)=>{Promise.resolve().then(s.bind(s,78590))},78590:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>I});var r=s(95155),a=s(12115),i=s(37206);let n={"image/jpeg":"jpg","image/jpg":"jpg","image/png":"png","image/webp":"webp","image/gif":"gif"};function l(e){return Object.keys(n).includes(e.type)?e.size>5242880?{isValid:!1,error:`图片大小不能超过 ${Math.round(5)}MB`}:{isValid:!0}:{isValid:!1,error:`不支持的图片格式。支持的格式：${Object.values(n).join(", ")}`}}async function o(e){let t=l(e);if(!t.isValid)throw Error(t.error);try{let[t,s]=await Promise.all([new Promise((t,s)=>{let r=new FileReader;r.onload=()=>{t(r.result.split(",")[1])},r.onerror=()=>{s(Error("图片读取失败"))},r.readAsDataURL(e)}),new Promise((t,s)=>{let r=new Image,a=URL.createObjectURL(e);r.onload=()=>{let e={width:r.width,height:r.height};URL.revokeObjectURL(a),t(e)},r.onerror=()=>{URL.revokeObjectURL(a),s(Error("无法读取图片尺寸"))},r.src=a})]);return{data:t,mimeType:e.type,dimensions:s,size:e.size,name:e.name}}catch(e){throw Error(`图片处理失败: ${e.message}`)}}let d={auto:"自动",flowchart:"流程图",mindmap:"思维导图",orgchart:"组织架构图",sequence:"时序图",class:"UML类图",er:"ER图",gantt:"甘特图",timeline:"时间线",tree:"树形图",network:"网络拓扑图",architecture:"架构图",dataflow:"数据流图",state:"状态图",swimlane:"泳道图",concept:"概念图",fishbone:"鱼骨图",swot:"SWOT分析图",pyramid:"金字塔图",funnel:"漏斗图",venn:"韦恩图",matrix:"矩阵图"};function c({onImageSelect:e,isGenerating:t,chartType:s,onChartTypeChange:i,onImageGenerate:n}){let[c,x]=(0,a.useState)(null),[u,m]=(0,a.useState)(null),[g,h]=(0,a.useState)(""),[f,p]=(0,a.useState)(""),[b,y]=(0,a.useState)(!1),j=(0,a.useRef)(null),v=(0,a.useRef)(0),w=async t=>{if(t){h("uploading"),p("");try{let s=l(t);if(!s.isValid)throw Error(s.error);let r=await new Promise((e,s)=>{let r=new FileReader;r.onload=()=>{e(r.result)},r.onerror=()=>{s(Error("图片预览失败"))},r.readAsDataURL(t)});x(r),m(t);let a=await o(t);h("success"),e&&e({...a,previewUrl:r,file:t})}catch(e){h("error"),p(e.message),console.error("图片处理失败:",e)}}};return(0,r.jsxs)("div",{className:"flex-1 flex flex-col p-4",children:[(0,r.jsx)("div",{className:"w-full mb-4",children:(0,r.jsx)("select",{id:"chart-type-image",value:s,onChange:e=>i?.(e.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white",disabled:t||"uploading"===g,children:Object.entries(d).map(([e,t])=>(0,r.jsx)("option",{value:e,children:t},e))})}),u?(0,r.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,r.jsxs)("div",{className:"flex-1 flex justify-center relative bg-gray-50 rounded-lg overflow-hidden border border-gray-200",children:[c&&(0,r.jsx)("img",{src:c,alt:"预览",className:"w-full object-contain"}),(0,r.jsx)("button",{onClick:()=>{x(null),m(null),h(""),p(""),j.current&&(j.current.value=""),e&&e(null)},disabled:t||"uploading"===g,className:"absolute top-3 right-3 p-2 bg-white rounded-full shadow-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200",title:"删除图片",children:(0,r.jsx)("svg",{className:"w-4 h-4 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),"success"===g&&(0,r.jsx)("div",{className:"absolute top-3 left-3",children:(0,r.jsx)("div",{className:"w-6 h-6 bg-green-600 rounded-full flex items-center justify-center",children:(0,r.jsx)("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})}),"uploading"===g&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-white/75",children:(0,r.jsx)("div",{className:"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"})}),u&&(0,r.jsx)("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3",children:(0,r.jsx)("p",{className:"text-xs font-medium text-white mb-1 truncate",title:u.name,children:u.name})})]}),f&&(0,r.jsx)("div",{className:"mt-2 p-2 bg-red-50 border border-red-200 rounded",children:(0,r.jsx)("p",{className:"text-xs text-red-600",children:f})}),"success"===g&&!t&&(0,r.jsxs)("button",{onClick:n,className:"w-full mt-2 px-4 py-3 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center space-x-2",children:[(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),(0,r.jsx)("span",{children:"开始生成"})]}),t&&"success"===g&&(0,r.jsxs)("div",{className:"mt-2 flex items-center justify-center text-sm text-blue-600",children:[(0,r.jsxs)("div",{className:"flex space-x-1 mr-2",children:[(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),(0,r.jsx)("span",{children:"正在识别..."})]})]}):(0,r.jsxs)("div",{className:`flex-1 flex flex-col items-center justify-center border-2 border-dashed rounded-lg transition-colors duration-200 ${b?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:e=>{e.preventDefault(),e.stopPropagation(),v.current++,e.dataTransfer.items&&e.dataTransfer.items.length>0&&y(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),v.current--,0===v.current&&y(!1)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:e=>{e.preventDefault(),e.stopPropagation(),y(!1),v.current=0;let t=e.dataTransfer.files;t&&t.length>0&&w(t[0])},children:[(0,r.jsxs)("div",{className:"text-center mb-4",children:[(0,r.jsx)("svg",{className:"mx-auto h-12 w-12 text-gray-400 mb-3",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48",children:(0,r.jsx)("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-1",children:"上传图片进行识别"}),(0,r.jsx)("p",{className:"text-xs text-gray-400",children:"支持 JPG、PNG、WebP、GIF 格式，最大 5MB"})]}),(0,r.jsx)("input",{ref:j,type:"file",accept:"image/*",onChange:e=>{let t=e.target.files?.[0];t&&w(t)},className:"hidden",disabled:t||"uploading"===g}),(0,r.jsx)("button",{onClick:()=>{t||"uploading"===g||j.current?.click()},disabled:t||"uploading"===g,className:"px-6 py-2 bg-gray-900 text-white text-sm rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center space-x-2",children:"uploading"===g?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,r.jsx)("span",{children:"处理中..."})]}):t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,r.jsx)("span",{children:"生成中..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),(0,r.jsx)("span",{children:"选择图片"})]})}),b&&(0,r.jsx)("p",{className:"mt-3 text-sm text-blue-600",children:"松开鼠标上传图片"})]})]})}function x({isVisible:e,message:t="处理中...",transparent:s=!1,className:a=""}){return e?(0,r.jsx)("div",{className:`absolute inset-0 z-50 flex items-center justify-center ${s?"bg-black/10 ":"bg-white/90 "} ${a}`,children:(0,r.jsxs)("div",{className:"flex flex-col items-center space-y-3",children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("div",{className:"w-8 h-8 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin"})}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("span",{className:"text-sm text-gray-700 font-medium",children:t}),(0,r.jsxs)("div",{className:"flex space-x-1",children:[(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-gray-700 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-gray-700 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-gray-700 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})]})]})}):null}let u={auto:"自动",flowchart:"流程图",mindmap:"思维导图",orgchart:"组织架构图",sequence:"时序图",class:"UML类图",er:"ER图",gantt:"甘特图",timeline:"时间线",tree:"树形图",network:"网络拓扑图",architecture:"架构图",dataflow:"数据流图",state:"状态图",swimlane:"泳道图",concept:"概念图",fishbone:"鱼骨图",swot:"SWOT分析图",pyramid:"金字塔图",funnel:"漏斗图",venn:"韦恩图",matrix:"矩阵图",infographic:"信息图"};function m({onSendMessage:e,isGenerating:t}){let[s,i]=(0,a.useState)("text"),[n,l]=(0,a.useState)(""),[o,d]=(0,a.useState)("auto"),[m,g]=(0,a.useState)(null),[h,f]=(0,a.useState)(""),[p,b]=(0,a.useState)(""),[y,j]=(0,a.useState)(null),[v,w]=(0,a.useState)(""),[N,C]=(0,a.useState)(!1),k=(0,a.useRef)(null),L=(0,a.useRef)(null),S=s=>{s.preventDefault(),n.trim()&&!t&&e(n.trim(),o)};return(0,r.jsxs)("div",{className:"flex flex-col h-full bg-white",children:[(0,r.jsxs)("div",{className:"flex border-b border-gray-200 bg-gray-50",children:[(0,r.jsx)("button",{onClick:()=>{i("text"),C(!1)},className:`flex-1 px-4 py-3 text-sm font-medium transition-colors duration-200 ${"text"===s?"bg-white text-gray-900 border-b-2 border-gray-900":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"文本输入"}),(0,r.jsx)("button",{onClick:()=>{i("file"),C(!!v)},className:`flex-1 px-4 py-3 text-sm font-medium transition-colors duration-200 ${"file"===s?"bg-white text-gray-900 border-b-2 border-gray-900":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"文件上传"}),(0,r.jsx)("button",{onClick:()=>{i("image"),C(!!y)},className:`flex-1 px-4 py-3 text-sm font-medium transition-colors duration-200 ${"image"===s?"bg-white text-gray-900 border-b-2 border-gray-900":"text-gray-600 hover:text-gray-900 hover:bg-gray-100"}`,children:"图片上传"})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col",children:["text"===s&&(0,r.jsxs)("div",{className:"flex-1 flex flex-col p-4 relative",children:[(0,r.jsxs)("form",{onSubmit:S,className:"flex-1 flex flex-col",children:[(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)("select",{id:"chart-type-text",value:o,onChange:e=>d(e.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white",disabled:t,children:Object.entries(u).map(([e,t])=>(0,r.jsx)("option",{value:e,children:t},e))})}),(0,r.jsxs)("div",{className:"relative flex-1",children:[(0,r.jsx)("textarea",{ref:k,value:n,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),S(e))},placeholder:"描述您想要创建的图表...",className:"w-full h-full pl-3 pr-12 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900 resize-none text-sm scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},disabled:t}),(0,r.jsx)("button",{type:"submit",disabled:!n.trim()||t,className:"absolute right-2 bottom-2 p-2 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200",title:t?"生成中...":"发送",children:t?(0,r.jsx)("div",{className:"flex items-center justify-center",children:(0,r.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"})}):(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})]}),(0,r.jsx)(x,{isVisible:t,message:"正在生成图表..."})]}),"file"===s&&(0,r.jsxs)("div",{className:"flex-1 flex flex-col items-center  p-4 relative",children:[(0,r.jsx)("div",{className:"w-full max-w-md mb-6",children:(0,r.jsx)("select",{id:"chart-type-file",value:o,onChange:e=>d(e.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900 bg-white",disabled:t||"parsing"===h,children:Object.entries(u).map(([e,t])=>(0,r.jsx)("option",{value:e,children:t},e))})}),(0,r.jsxs)("div",{className:"text-center mb-6",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:"上传 Markdown 或文本文件"}),(0,r.jsx)("p",{className:"text-xs text-gray-400",children:"支持 .md 和 .txt 格式，最大 1MB"})]}),(0,r.jsx)("input",{ref:L,type:"file",accept:".md,.txt",onChange:e=>{let t=e.target.files?.[0];if(!t){g(null),f(""),b(""),w(""),C(!1);return}if(![".md",".txt"].includes(t.name.substring(t.name.lastIndexOf(".")).toLowerCase())){b("请选择 .md 或 .txt 文件"),f("error"),C(!1);return}if(t.size>1048576){b("文件大小不能超过 1MB"),f("error"),C(!1);return}g(t),f("parsing"),b(""),w(""),C(!1);let s=new FileReader;s.onload=e=>{let t=e.target?.result;"string"==typeof t&&t.trim()?(f("success"),w(t.trim()),C(!0)):(b("文件内容为空"),f("error"),C(!1))},s.onerror=()=>{b("文件读取失败"),f("error"),C(!1)},s.readAsText(t)},className:"hidden",disabled:t||"parsing"===h}),(0,r.jsxs)("button",{onClick:()=>{L.current?.click()},disabled:t||"parsing"===h,className:"px-6 py-3 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center space-x-2",children:[t||"parsing"===h?(0,r.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),(0,r.jsx)("span",{children:"parsing"===h?"解析中...":t?"生成中...":"选择文件"})]}),m&&(0,r.jsxs)("div",{className:"mt-6 w-full max-w-md",children:[(0,r.jsx)("div",{className:`p-4 rounded border ${"success"===h?"bg-green-50 border-green-200":"error"===h?"bg-red-50 border-red-200":"bg-blue-50 border-blue-200"}`,children:(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:["parsing"===h&&(0,r.jsxs)("div",{className:"flex space-x-1",children:[(0,r.jsx)("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),(0,r.jsx)("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),(0,r.jsx)("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),"success"===h&&(0,r.jsx)("svg",{className:"w-5 h-5 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),"error"===h&&(0,r.jsx)("svg",{className:"w-5 h-5 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:m.name}),"success"===h&&!t&&(0,r.jsx)("p",{className:"text-xs text-green-600 mt-1",children:"文件已上传，可以开始生成"}),"success"===h&&t&&(0,r.jsx)("p",{className:"text-xs text-blue-600 mt-1",children:"正在生成图表..."}),"error"===h&&(0,r.jsx)("p",{className:"text-xs text-red-600 mt-1",children:p}),"parsing"===h&&(0,r.jsx)("p",{className:"text-xs text-blue-600 mt-1",children:"正在解析文件..."})]})]})}),"success"===h&&!t&&(0,r.jsx)("div",{className:"mt-4",children:(0,r.jsxs)("button",{onClick:()=>{v&&!t&&(e(v,o),C(!1))},disabled:!N,className:"w-full px-4 py-3 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center space-x-2",children:[(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),(0,r.jsx)("span",{children:"开始生成"})]})})]}),(0,r.jsx)(x,{isVisible:t||"parsing"===h,message:"parsing"===h?"正在解析文件...":"正在生成图表..."})]}),"image"===s&&(0,r.jsxs)("div",{className:"flex-1 flex flex-col relative",children:[(0,r.jsx)(c,{onImageSelect:e=>{j(e),e?C(!0):C(!1)},isGenerating:t,chartType:o,onChartTypeChange:d,onImageGenerate:()=>{if(y&&!t){let t;e({text:(t=o&&"auto"!==o?`请将图片内容转换为${({flowchart:"流程图",mindmap:"思维导图",orgchart:"组织架构图",sequence:"时序图",class:"UML类图",er:"ER图",gantt:"甘特图",timeline:"时间线",tree:"树形图",network:"网络拓扑图",architecture:"架构图",dataflow:"数据流图",state:"状态图",swimlane:"泳道图",concept:"概念图",fishbone:"鱼骨图",swot:"SWOT分析图",pyramid:"金字塔图",funnel:"漏斗图",venn:"韦恩图",matrix:"矩阵图"})[o]||"自动"}类型的Excalidraw图表。`:"请分析图片内容并选择合适的图表类型转换为Excalidraw图表。",`${t}

请仔细分析图片中的：
1. 文字内容和标签
2. 图形元素和结构
3. 流程或连接关系
4. 布局和层次关系
5. 数据或数值信息

基于分析结果，创建清晰、准确的Excalidraw图表，确保：
- 保留图片中的所有关键信息
- 使用合适的图表类型展示内容
- 保持逻辑关系和结构
- 添加必要的文字说明

将图片里的内容转换为excalidraw`),image:y,chartType:o},o),C(!1)}}}),(0,r.jsx)(x,{isVisible:t,message:"正在识别图片内容并生成图表..."})]})]})]})}var g=s(28202);function h({code:e,onChange:t,onApply:s,onOptimize:a,onClear:i,jsonError:n,onClearJsonError:l,isGenerating:o,isApplyingCode:d,isOptimizingCode:c}){return(0,r.jsxs)("div",{className:"flex relative flex-col h-full bg-gray-50 border-t border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200",children:[(0,r.jsx)("h3",{className:"text-sm font-semibold text-gray-700",children:"生成的代码"}),(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsxs)("button",{onClick:i,disabled:o||d||c,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors duration-200 flex items-center gap-2",children:["清除",o&&(0,r.jsx)("div",{className:"w-3 h-3 border border-gray-400 border-t-transparent rounded-full animate-spin"})]}),(0,r.jsx)("button",{onClick:a,disabled:o||d||c||!e.trim(),className:"px-4 py-2 text-sm font-medium text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center gap-2",style:{background:o||d||c?"#d1d5db":"linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)"},title:"优化图标布局和箭头连接",children:c?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,r.jsx)("span",{children:"优化中..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{children:"优化"}),o&&(0,r.jsx)("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"})]})}),(0,r.jsx)("button",{onClick:s,disabled:o||d||c||!e.trim(),className:"px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 flex items-center gap-2",children:d?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,r.jsx)("span",{children:"应用中..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("span",{children:"应用"}),(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-4 h-4",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"})}),o&&(0,r.jsx)("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"})]})})]})]}),n&&(0,r.jsxs)("div",{className:"absolute bottom-0 z-1 border-b border-red-200 px-4 py-3 flex items-start justify-between bg-white",children:[(0,r.jsxs)("div",{className:"flex items-start space-x-2",children:[(0,r.jsx)("svg",{className:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)("p",{className:"text-red-700 mt-1 font-mono",style:{fontSize:"12px"},children:n})})]}),(0,r.jsx)("button",{onClick:l,className:"text-red-600 hover:text-red-800 transition-colors ml-2",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)(g.KE,{height:"100%",defaultLanguage:"javascript",value:e,onChange:t,theme:"vs-light",options:{minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,wordWrap:"on"}})})]})}class f{constructor(){this.STORAGE_KEY="smart-excalidraw-configs",this.ACTIVE_CONFIG_KEY="smart-excalidraw-active-config",this.configs=[],this.activeConfigId=null,this.isLoaded=!1}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}ensureLoaded(){this.isLoaded||this.loadConfigs()}getActiveConfigId(){return this.ensureLoaded(),this.activeConfigId}loadConfigs(){try{let e=localStorage.getItem(this.STORAGE_KEY);this.configs=e?JSON.parse(e):[],this.activeConfigId=localStorage.getItem(this.ACTIVE_CONFIG_KEY),this.isLoaded=!0,!this.activeConfigId&&this.configs.length>0&&(this.activeConfigId=this.configs[0].id,this.saveActiveConfigId())}catch(e){console.error("Failed to load configs:",e),this.configs=[],this.activeConfigId=null,this.isLoaded=!0}}saveConfigs(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.configs))}catch(e){console.error("Failed to save configs:",e)}}saveActiveConfigId(){try{this.activeConfigId?localStorage.setItem(this.ACTIVE_CONFIG_KEY,this.activeConfigId):localStorage.removeItem(this.ACTIVE_CONFIG_KEY)}catch(e){console.error("Failed to save active config ID:",e)}}createConfig(e){let t={id:this.generateId(),name:e.name||"新配置",type:e.type||"openai",baseUrl:e.baseUrl||"",apiKey:e.apiKey||"",model:e.model||"",description:e.description||"",isActive:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),...e};return this.configs.push(t),1===this.configs.length&&this.setActiveConfig(t.id),this.saveConfigs(),t}updateConfig(e,t){let s=this.configs.findIndex(t=>t.id===e);if(-1===s)throw Error("配置不存在");return this.configs[s]={...this.configs[s],...t,id:e,updatedAt:new Date().toISOString()},this.saveConfigs(),this.configs[s]}deleteConfig(e){let t=this.configs.findIndex(t=>t.id===e);if(-1===t)throw Error("配置不存在");if(this.activeConfigId===e)if(this.activeConfigId=null,this.configs.length>1){let t=this.configs.filter(t=>t.id!==e);this.activeConfigId=t[0].id,this.saveActiveConfigId()}else this.saveActiveConfigId();this.configs.splice(t,1),this.saveConfigs()}getAllConfigs(){return this.ensureLoaded(),[...this.configs]}getConfig(e){return this.ensureLoaded(),this.configs.find(t=>t.id===e)}getActiveConfig(){return(this.ensureLoaded(),this.activeConfigId)?this.getConfig(this.activeConfigId):null}setActiveConfig(e){let t=this.getConfig(e);if(!t)throw Error("配置不存在");return this.activeConfigId=e,this.saveActiveConfigId(),t}cloneConfig(e,t){this.ensureLoaded();let s=this.getConfig(e);if(!s)throw Error("原配置不存在");let r={...s,name:t||`${s.name} (副本)`,isActive:!1};return delete r.id,delete r.createdAt,delete r.updatedAt,this.createConfig(r)}validateConfig(e){let t=[];if(e.name&&""!==e.name.trim()||t.push("配置名称不能为空"),e.type&&["openai","anthropic"].includes(e.type)||t.push("配置类型必须是 openai 或 anthropic"),e.baseUrl&&""!==e.baseUrl.trim())try{new URL(e.baseUrl)}catch{t.push("API地址格式不正确")}else t.push("API地址不能为空");return e.apiKey&&""!==e.apiKey.trim()||t.push("API密钥不能为空"),e.model&&""!==e.model.trim()||t.push("模型名称不能为空"),{isValid:0===t.length,errors:t}}async testConnection(e){let t=this.validateConfig(e);if(!t.isValid)throw Error("配置无效: "+t.errors.join(", "));try{return{success:!0,message:"连接测试成功"}}catch(e){return{success:!1,message:e.message}}}importConfigs(e){try{let t=JSON.parse(e);if(!Array.isArray(t))throw Error("导入数据格式错误");let s=0;for(let e of t)this.validateConfig(e).isValid&&(this.createConfig({...e,isActive:!1}),s++);return{success:!0,count:s}}catch(e){return{success:!1,message:e.message}}}exportConfigs(){return JSON.stringify(this.configs,null,2)}searchConfigs(e){this.ensureLoaded();let t=e.toLowerCase();return this.configs.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.type.toLowerCase().includes(t))}getStats(){this.ensureLoaded();let e={total:this.configs.length,active:0,byType:{}};return this.configs.forEach(t=>{t.id===this.activeConfigId&&(e.active=1);let s=t.type;e.byType[s]=(e.byType[s]||0)+1}),e}}let p=new f;function b({isOpen:e,onClose:t,title:s,message:i,type:n="info",autoClose:l=!0,duration:o=3e3}){if((0,a.useEffect)(()=>{if(e&&l){let e=setTimeout(()=>{t()},o);return()=>clearTimeout(e)}},[e,l,o,t]),!e)return null;let d={success:{container:"bg-green-50 border-green-200",title:"text-green-800",message:"text-green-700",icon:"✓"},error:{container:"bg-red-50 border-red-200",title:"text-red-800",message:"text-red-700",icon:"✕"},warning:{container:"bg-yellow-50 border-yellow-200",title:"text-yellow-800",message:"text-yellow-700",icon:"⚠"},info:{container:"bg-blue-50 border-blue-200",title:"text-blue-800",message:"text-blue-700",icon:"ℹ"}},c=d[n]||d.info;return(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-start justify-center pt-20 px-4",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/25",onClick:t}),(0,r.jsx)("div",{className:"relative max-w-xs w-full min-w-0",children:(0,r.jsx)("div",{className:`border rounded-lg shadow-lg p-4 ${c.container}`,children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[(0,r.jsx)("span",{className:`text-xl ${c.title} flex-shrink-0`,children:c.icon}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[s&&(0,r.jsx)("h3",{className:`font-semibold text-xs ${c.title} break-words`,children:s}),i&&(0,r.jsx)("p",{className:`text-xs mt-1 whitespace-pre-wrap break-words ${c.message}`,children:i})]})]}),(0,r.jsx)("button",{onClick:t,className:`ml-4 text-gray-400 hover:text-gray-600 transition-colors ${c.title}`,children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})})})]})}function y({isOpen:e,onClose:t,onConfirm:s,title:a="确认操作",message:i,confirmText:n="确认",cancelText:l="取消",type:o="warning"}){if(!e)return null;let d={warning:{container:"bg-yellow-50 border-yellow-200",title:"text-yellow-800",message:"text-yellow-700",confirmButton:"bg-yellow-600 hover:bg-yellow-700 text-white"},danger:{container:"bg-red-50 border-red-200",title:"text-red-800",message:"text-red-700",confirmButton:"bg-red-600 hover:bg-red-700 text-white"},info:{container:"bg-blue-50 border-blue-200",title:"text-blue-800",message:"text-blue-700",confirmButton:"bg-blue-600 hover:bg-blue-700 text-white"}},c=d[o]||d.warning;return(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/50",onClick:t}),(0,r.jsxs)("div",{className:"relative bg-white rounded-lg border border-gray-300 w-full max-w-md mx-4 shadow-xl",children:[(0,r.jsx)("div",{className:"px-6 py-4 border-b border-gray-200",children:(0,r.jsx)("h2",{className:`text-lg font-semibold ${c.title}`,children:a})}),(0,r.jsx)("div",{className:"px-6 py-4",children:(0,r.jsx)("p",{className:`text-sm ${c.message}`,children:i})}),(0,r.jsxs)("div",{className:"flex justify-end space-x-3 px-6 py-4 border-t border-gray-200",children:[(0,r.jsx)("button",{onClick:t,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:l}),(0,r.jsx)("button",{onClick:s,className:`px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 ${c.confirmButton}`,children:n})]})]})]})}function j({isOpen:e,onClose:t,onConfigSelect:s}){let[i,n]=(0,a.useState)([]),[l,o]=(0,a.useState)(null),[d,c]=(0,a.useState)(null),[x,u]=(0,a.useState)(""),[m,g]=(0,a.useState)(!1),[h,f]=(0,a.useState)(!1),[j,w]=(0,a.useState)(""),[N,C]=(0,a.useState)({isOpen:!1,title:"",message:"",type:"info"}),[k,L]=(0,a.useState)({isOpen:!1,title:"",message:"",onConfirm:null});(0,a.useEffect)(()=>{e&&S()},[e]);let S=()=>{try{let e=p.getAllConfigs(),t=p.getActiveConfigId();n(e),o(t)}catch(e){w("加载配置失败: "+e.message)}},E=async e=>{L({isOpen:!0,title:"确认删除",message:"确定要删除这个配置吗？此操作不可恢复。",onConfirm:async()=>{try{await p.deleteConfig(e),S(),w(""),C({isOpen:!0,title:"删除成功",message:"配置已成功删除",type:"success"})}catch(e){w("删除配置失败: "+e.message)}}})},O=async e=>{try{await p.setActiveConfig(e),S(),s?.(p.getActiveConfig()),w("")}catch(e){w("切换配置失败: "+e.message)}},I=async e=>{f(!0),w("");try{let t=await p.testConnection(e);t.success?C({isOpen:!0,title:"连接测试成功",message:t.message,type:"success"}):C({isOpen:!0,title:"连接测试失败",message:t.message,type:"error"})}catch(e){C({isOpen:!0,title:"连接测试失败",message:e.message,type:"error"})}finally{f(!1)}},A=x?p.searchConfigs(x):i;return e?d?(0,r.jsx)(v,{config:d,isCreating:m,onSave:e=>{try{if(m){let t=p.createConfig(e);0===i.length&&s?.(t)}else p.updateConfig(d.id,e),d.id===l&&s?.(p.getConfig(d.id));c(null),g(!1),S(),w("")}catch(e){w("保存配置失败: "+e.message)}},onCancel:()=>{c(null),g(!1)}}):(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/50",onClick:t}),(0,r.jsxs)("div",{className:"relative bg-white rounded border border-gray-300 w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"配置管理"}),(0,r.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600 transition-colors duration-200",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:[j&&(0,r.jsx)("div",{className:"mb-4 px-4 py-3 bg-red-50 border border-red-200 rounded",children:(0,r.jsx)("p",{className:"text-sm text-red-800",children:j})}),(0,r.jsxs)("div",{className:"mb-6 flex flex-wrap gap-2",children:[(0,r.jsx)("button",{onClick:()=>{g(!0),c({name:"",type:"openai",baseUrl:"",apiKey:"",model:"",description:""})},className:"px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800 transition-colors duration-200",children:"新建配置"}),(0,r.jsx)("button",{onClick:()=>{try{let e=p.exportConfigs(),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download="llm-configs.json",r.click(),URL.revokeObjectURL(s)}catch(e){w("导出配置失败: "+e.message)}},className:"px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors duration-200",children:"导出配置"}),(0,r.jsx)("button",{onClick:()=>{let e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{let t=e.target.files[0];if(t)try{let e=await t.text(),s=p.importConfigs(e);s.success?(C({isOpen:!0,title:"导入成功",message:`成功导入 ${s.count} 个配置`,type:"success"}),S()):w("导入配置失败: "+s.message)}catch(e){w("导入配置失败: "+e.message)}},e.click()},className:"px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors duration-200",children:"导入配置"})]}),(0,r.jsx)("div",{className:"mb-4",children:(0,r.jsx)("input",{type:"text",value:x,onChange:e=>u(e.target.value),placeholder:"搜索配置...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})}),(0,r.jsx)("div",{className:"space-y-3",children:0===A.length?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:x?"没有找到匹配的配置":'暂无配置，点击"新建配置"创建第一个配置'}):A.map(e=>(0,r.jsx)("div",{className:`border rounded-lg p-4 ${e.id===l?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,r.jsx)("h3",{className:"font-medium text-gray-900",children:e.name}),e.id===l&&(0,r.jsx)("span",{className:"px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded",children:"当前使用"}),(0,r.jsx)("span",{className:"px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded",children:e.type})]}),e.description&&(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-2",children:e.description}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 space-y-1",children:[(0,r.jsxs)("div",{children:["URL: ",e.baseUrl]}),(0,r.jsxs)("div",{children:["模型: ",e.model]}),(0,r.jsxs)("div",{children:["创建时间: ",new Date(e.createdAt).toLocaleString()]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 ml-4",children:[e.id!==l&&(0,r.jsx)("button",{onClick:()=>O(e.id),className:"px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors duration-200",children:"设为当前"}),(0,r.jsx)("button",{onClick:()=>I(e),disabled:h,className:"px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors duration-200 disabled:bg-gray-400",children:"测试"}),(0,r.jsx)("button",{onClick:()=>{g(!1),c({...e})},className:"px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors duration-200",children:"编辑"}),(0,r.jsx)("button",{onClick:()=>(e=>{let t=`${e.name} (副本)`;try{p.cloneConfig(e.id,t),S(),w("")}catch(e){w("克隆配置失败: "+e.message)}})(e),className:"px-3 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors duration-200",children:"克隆"}),i.length>1&&(0,r.jsx)("button",{onClick:()=>E(e.id),className:"px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors duration-200",children:"删除"})]})]})},e.id))})]})]}),(0,r.jsx)(b,{isOpen:N.isOpen,onClose:()=>C({...N,isOpen:!1}),title:N.title,message:N.message,type:N.type}),(0,r.jsx)(y,{isOpen:k.isOpen,onClose:()=>L({...k,isOpen:!1}),onConfirm:()=>{k.onConfirm?.(),L({...k,isOpen:!1})},title:k.title,message:k.message,type:"danger"})]}):null}function v({config:e,isCreating:t,onSave:s,onCancel:i}){let[n,l]=(0,a.useState)({...e}),[o,d]=(0,a.useState)([]),[c,x]=(0,a.useState)(!1),[u,m]=(0,a.useState)(!0),[g,h]=(0,a.useState)("");(0,a.useEffect)(()=>{n.model&&(o.length>0?m(!o.some(e=>e.id===n.model)):m(!0))},[o,n.model]);let f=async()=>{if(!n.type||!n.baseUrl||!n.apiKey)return void h("请先填写提供商类型、基础 URL 和 API 密钥");x(!0),h("");try{let e=new URLSearchParams({type:n.type,baseUrl:n.baseUrl,apiKey:n.apiKey}),t=await fetch(`/api/models?${e}`),s=await t.json();if(!t.ok)throw Error(s.error||"加载模型失败");d(s.models)}catch(e){h(e.message),d([])}finally{x(!1)}};return(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/50",onClick:i}),(0,r.jsxs)("div",{className:"relative bg-white rounded border border-gray-300 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:t?"新建配置":"编辑配置"}),(0,r.jsx)("button",{onClick:i,className:"text-gray-400 hover:text-gray-600 transition-colors duration-200",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsxs)("div",{className:"px-6 py-4 space-y-4",children:[g&&(0,r.jsx)("div",{className:"px-4 py-3 bg-red-50 border border-red-200 rounded",children:(0,r.jsx)("p",{className:"text-sm text-red-800",children:g})}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["配置名称 ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"text",value:n.name,onChange:e=>l({...n,name:e.target.value}),placeholder:"例如：我的 OpenAI",className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"描述"}),(0,r.jsx)("textarea",{value:n.description||"",onChange:e=>l({...n,description:e.target.value}),placeholder:"配置描述（可选）",rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["提供商类型 ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("select",{value:n.type,onChange:e=>l({...n,type:e.target.value,model:""}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900",children:[(0,r.jsx)("option",{value:"openai",children:"OpenAI"}),(0,r.jsx)("option",{value:"anthropic",children:"Anthropic"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["基础 URL ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"text",value:n.baseUrl,onChange:e=>l({...n,baseUrl:e.target.value}),placeholder:"openai"===n.type?"https://api.openai.com/v1":"https://api.anthropic.com/v1",className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["API 密钥 ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"password",value:n.apiKey,onChange:e=>l({...n,apiKey:e.target.value}),placeholder:"sk-...",className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})]}),(0,r.jsx)("div",{children:(0,r.jsx)("button",{onClick:f,disabled:c,className:"w-full px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 disabled:bg-gray-50 disabled:text-gray-400 transition-colors duration-200 font-medium",children:c?"加载模型中...":"加载可用模型"})}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["模型 ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),o.length>0&&(0,r.jsxs)("div",{className:"mb-2 flex items-center space-x-4",children:[(0,r.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"radio",checked:!u,onChange:()=>{m(!1),o.length>0&&l({...n,model:o[0].id})},className:"mr-2"}),(0,r.jsx)("span",{className:"text-sm text-gray-700",children:"从列表选择"})]}),(0,r.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"radio",checked:u,onChange:()=>{m(!0),l({...n,model:""})},className:"mr-2"}),(0,r.jsx)("span",{className:"text-sm text-gray-700",children:"手动输入"})]})]}),o.length>0&&!u&&(0,r.jsx)("select",{value:n.model,onChange:e=>l({...n,model:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900",children:o.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))}),(u||0===o.length)&&(0,r.jsx)("input",{type:"text",value:n.model,onChange:e=>l({...n,model:e.target.value}),placeholder:"例如：gpt-4、claude-3-opus-20240229",className:"w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-900"})]})]}),(0,r.jsxs)("div",{className:"flex justify-end space-x-3 px-6 py-4 border-t border-gray-200",children:[(0,r.jsx)("button",{onClick:i,className:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors duration-200",children:"取消"}),(0,r.jsx)("button",{onClick:()=>{n.name&&n.type&&n.baseUrl&&n.apiKey&&n.model?s(n):h("请填写所有必填字段")},className:"px-4 py-2 text-white bg-gray-900 rounded hover:bg-gray-800 transition-colors duration-200",children:t?"创建":"保存"})]})]})]})}function w({isOpen:e,onClose:t}){return e?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-sm w-full mx-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"联系作者"}),(0,r.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600 transition-colors",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,r.jsxs)("div",{className:"flex flex-col items-center space-y-4",children:[(0,r.jsx)("img",{src:"/qrcode.png",alt:"微信二维码",className:"w-48  rounded-lg",onError:e=>{e.target.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='sans-serif' font-size='14' fill='%236b7280'%3E二维码暂未上传%3C/text%3E%3C/svg%3E"}}),(0,r.jsx)("p",{className:"text-gray-500 text-sm text-center",children:"扫描二维码，添加作者微信"})]})]})}):null}let N="smart-excalidraw-config";function C(){try{let e=localStorage.getItem(N);if(e&&0===p.getAllConfigs().length){let t=JSON.parse(e);p.createConfig({name:t.name||"迁移的配置",type:t.type,baseUrl:t.baseUrl,apiKey:t.apiKey,model:t.model,description:"从旧版本迁移的配置"}),localStorage.removeItem(N)}}catch(e){console.error("Failed to migrate legacy config:",e)}let e=p.getActiveConfig();return e?{name:e.name,type:e.type,baseUrl:e.baseUrl,apiKey:e.apiKey,model:e.model}:null}function k(e){return!!e&&!!(e.type&&e.baseUrl&&e.apiKey&&e.model)}function L(e,t){let s,r,a=e.x||0,i=e.y||0,n=e.width||100,l=e.height||100,o=t.x||0,d=t.y||0,c=t.width||100,x=t.height||100,u=a+n/2-(o+c/2),m=i+l/2-(d+x/2),g=a-(o+c),h=-(a+n-o),f=i-(d+x),p=-(i+l-d);return u>0&&m>0?g>f?(s="left",r="right"):(s="top",r="bottom"):u<0&&m>0?h>f?(s="right",r="left"):(s="top",r="bottom"):u>0&&m<0?g>p?(s="left",r="right"):(s="bottom",r="top"):u<0&&m<0?h>p?(s="right",r="left"):(s="bottom",r="top"):0===u&&m>0?(s="top",r="bottom"):0===u&&m<0?(s="bottom",r="top"):u>0&&0===m?(s="left",r="right"):(s="right",r="left"),{startEdge:s,endEdge:r}}function S(e,t){let s=e.x||0,r=e.y||0,a=e.width||100,i=e.height||100;switch(t){case"left":return{x:s,y:r+i/2};case"right":default:return{x:s+a,y:r+i/2};case"top":return{x:s+a/2,y:r};case"bottom":return{x:s+a/2,y:r+i}}}function E(e){if(!e||"string"!=typeof e)return e;try{let t=e.trim().match(/\[[\s\S]*\]/);if(!t)return console.error("No array found in code"),e;let s=JSON.parse(t[0]);if(!Array.isArray(s))return console.error("Parsed code is not an array"),e;let r=new Map;s.forEach(e=>{e.id&&r.set(e.id,e)});let a=s.map(e=>{if("arrow"!==e.type&&"line"!==e.type)return e;let t={...e},s=!1,a=e.start&&e.start.id?r.get(e.start.id):null,i=e.end&&e.end.id?r.get(e.end.id):null;if(a&&i){let e=function(e,t){let{startEdge:s}=L(e,t);return S(e,s)}(a,i);t.x=e.x,t.y=e.y;let r=function(e,t){let{endEdge:s}=L(t,e);return S(e,s)}(i,a);t.width=r.x-e.x,t.height=r.y-e.y,s=!0}return("arrow"===e.type||"line"===e.type)&&0===t.width&&(t.width=1,s=!0),s?t:e});return JSON.stringify(a,null,2)}catch(t){return console.error("Failed to optimize arrows:",t),e}}let O=(0,i.default)(()=>Promise.all([s.e(5219),s.e(5033),s.e(1077),s.e(4120),s.e(4932),s.e(4699)]).then(s.bind(s,74699)),{loadableGenerated:{webpack:()=>[74699]},ssr:!1});function I(){let[e,t]=(0,a.useState)(null),[s,i]=(0,a.useState)(!1),[n,l]=(0,a.useState)(!1),[o,d]=(0,a.useState)(""),[c,x]=(0,a.useState)([]),[u,g]=(0,a.useState)(!1),[f,p]=(0,a.useState)(!1),[y,v]=(0,a.useState)(!1),[N,L]=(0,a.useState)(25),[S,I]=(0,a.useState)(!1),[A,M]=(0,a.useState)(null),[R,U]=(0,a.useState)(null),[D,z]=(0,a.useState)({isOpen:!1,title:"",message:"",type:"info"});(0,a.useEffect)(()=>{let e=C();e&&t(e);let s=e=>{("smart-excalidraw-active-config"===e.key||"smart-excalidraw-configs"===e.key)&&t(C())};return window.addEventListener("storage",s),()=>window.removeEventListener("storage",s)},[]);let B=e=>{if(!e||"string"!=typeof e)return e;let t=e.trim();t=(t=(t=t.replace(/^```(?:json|javascript|js)?\s*\n?/i,"")).replace(/\n?```\s*$/,"")).trim();try{return JSON.parse(t),t}catch(e){return $(t)}},$=e=>{let t="",s=!1,r=!1;for(let a=0;a<e.length;a++){let i=e[a];if(a>0&&e[a-1],r){t+=i,r=!1;continue}if("\\"===i){t+=i,r=!0;continue}if('"'===i)if(s){let r=e.slice(a+1).match(/^\s*(.)/),n=r?r[1]:"";":"===n||","===n||"}"===n||"]"===n||""===n?(s=!1,t+=i):t+='\\"'}else s=!0,t+=i;else t+=i}return t},T=async(t,s="auto")=>{if(!k(e)){z({isOpen:!0,title:"配置提醒",message:"请先配置您的 LLM 提供商",type:"warning"}),i(!0);return}g(!0),M(null),U(null);try{let r=await fetch("/api/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({config:e,userInput:t,chartType:s})});if(!r.ok){let e="生成代码失败";try{let t=await r.json();t.error&&(e=t.error)}catch(t){switch(r.status){case 400:e="请求参数错误，请检查输入内容";break;case 401:case 403:e="API 密钥无效或权限不足，请检查配置";break;case 429:e="请求过于频繁，请稍后再试";break;case 500:case 502:case 503:e="服务器错误，请稍后重试";break;default:e=`请求失败 (${r.status})`}}throw Error(e)}let a=r.body.getReader(),i=new TextDecoder,n="",l="";for(;;){let{done:e,value:t}=await a.read();if(e)break;let s=(l+=i.decode(t,{stream:!0})).split("\n");for(let e of(l=s.pop()||"",s))if(""!==e.trim()&&"data: [DONE]"!==e.trim()&&e.startsWith("data: "))try{let t=JSON.parse(e.slice(6));if(t.content){n+=t.content;let e=B(n);d(e)}else if(t.error)throw Error(t.error)}catch(e){e.message&&!e.message.includes("Unexpected")&&M("数据流解析错误："+e.message),console.error("Failed to parse SSE:",e)}}let o=B(n);K(o);let c=E(o);d(c),K(c)}catch(e){console.error("Error generating code:",e),"Failed to fetch"===e.message||"TypeError"===e.name?M("网络连接失败，请检查网络连接"):M(e.message)}finally{g(!1)}},K=e=>{try{U(null);let t=e.trim().match(/\[[\s\S]*\]/);if(!t){U("代码中未找到有效的 JSON 数组"),console.error("No array found in generated code");return}let s=JSON.parse(t[0]);Array.isArray(s)&&(x(s),U(null))}catch(e){console.error("Failed to parse generated code:",e),e instanceof SyntaxError?U("JSON 语法错误："+e.message):U("解析失败："+e.message)}},P=async()=>{p(!0);try{await new Promise(e=>setTimeout(e,300)),K(o)}catch(e){console.error("Error applying code:",e)}finally{p(!1)}},F=async()=>{v(!0);try{await new Promise(e=>setTimeout(e,500));let e=E(o);d(e),K(e)}catch(e){console.error("Error optimizing code:",e)}finally{v(!1)}};return(0,a.useEffect)(()=>{let e=e=>{S&&L(Math.min(Math.max(e.clientX/window.innerWidth*100,20),80))},t=()=>{I(!1)};return S&&(document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[S]),(0,r.jsxs)("div",{className:"flex flex-col h-screen bg-gray-50",children:[(0,r.jsxs)("header",{className:"flex items-center justify-between px-6 h-[50px] bg-white border-b border-gray-200",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-lg leading-tight font-semibold text-gray-900",children:"Smart Excalidraw"}),(0,r.jsx)("p",{className:"text-xs leading-tight text-gray-500",children:"AI 驱动的图表生成"})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[e&&k(e)&&(0,r.jsxs)("div",{className:"flex items-center space-x-2 px-3 py-1.5 bg-green-50 rounded border border-green-300",children:[(0,r.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),(0,r.jsxs)("span",{className:"text-xs text-green-900 font-medium",children:[e.name||e.type," - ",e.model]})]}),(0,r.jsxs)("a",{href:"https://github.com/liujuntao123/smart-excalidraw-next",target:"_blank",rel:"noopener noreferrer",className:"flex items-center space-x-1 text-gray-600 hover:text-gray-900 transition-colors","aria-label":"GitHub 仓库",children:[(0,r.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z",clipRule:"evenodd"})}),(0,r.jsx)("span",{className:"text-sm",children:"GitHub"})]}),(0,r.jsx)("div",{className:"flex items-center space-x-2",children:(0,r.jsx)("button",{onClick:()=>i(!0),className:"px-4 py-2 text-sm font-medium text-white bg-gray-900 border border-gray-900 rounded hover:bg-gray-800 transition-colors duration-200",children:"管理配置"})})]})]}),(0,r.jsxs)("div",{className:"flex flex-1 overflow-hidden pb-1",children:[(0,r.jsxs)("div",{id:"left-panel",style:{width:`${N}%`},className:"flex flex-col border-r border-gray-200 bg-white",children:[A&&(0,r.jsxs)("div",{className:"bg-red-50 border-b border-red-200 px-4 py-3 flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex items-start space-x-2 min-w-0 flex-1",children:[(0,r.jsx)("svg",{className:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),(0,r.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,r.jsx)("p",{className:"text-xs font-medium text-red-800",children:"请求失败"}),(0,r.jsx)("p",{className:"text-xs text-red-700 mt-1 break-words",children:A})]})]}),(0,r.jsx)("button",{onClick:()=>M(null),className:"text-red-600 hover:text-red-800 transition-colors",children:(0,r.jsx)("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,r.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),(0,r.jsx)("div",{style:{height:"50%"},className:"overflow-auto",children:(0,r.jsx)(m,{onSendMessage:T,isGenerating:u})}),(0,r.jsx)("div",{style:{height:"50%"},className:"overflow-hidden",children:(0,r.jsx)(h,{code:o,onChange:d,onApply:P,onOptimize:F,onClear:()=>{d("")},jsonError:R,onClearJsonError:()=>U(null),isGenerating:u,isApplyingCode:f,isOptimizingCode:y})})]}),(0,r.jsx)("div",{onMouseDown:e=>{I(!0),e.preventDefault()},className:"w-1 bg-gray-200 hover:bg-gray-400 cursor-col-resize transition-colors duration-200 flex-shrink-0"}),(0,r.jsx)("div",{style:{width:`${100-N}%`},className:"bg-gray-50",children:(0,r.jsx)(O,{elements:c})})]}),(0,r.jsx)(j,{isOpen:s,onClose:()=>i(!1),onConfigSelect:e=>{e&&t(e)}}),(0,r.jsx)(w,{isOpen:n,onClose:()=>l(!1)}),(0,r.jsx)(b,{isOpen:D.isOpen,onClose:()=>z({...D,isOpen:!1}),title:D.title,message:D.message,type:D.type})]})}}},e=>{e.O(0,[9305,8441,3794,7358],()=>e(e.s=305)),_N_E=e.O()}]);